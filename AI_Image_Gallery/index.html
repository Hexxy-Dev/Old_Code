<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Image Gallery</title>
    <style>
      .image {
        display: inline-block;
        margin: 10px;
      }
      .hidden {
        display: none;
      }
      body {
        text-align: center;
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      #overlay.show {
        display: flex;
      }

      #overlay-content {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 20px;
        max-width: 80%;
        max-height: 80%;
        overflow: auto;
        position: relative;
      }

      #close {
        position: absolute;
        top: 5%;
        right: 41.5%;
        font-size: 30px;
        color: #ff0000;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="show-all-keywords">Show All Keywords</button>
    <div id="overlay"><span id="close">&times;</span><div id="overlay-content"><ul></ul></div></div>
    <script>
      const overlayDiv = document.getElementById('overlay');
      document.getElementById('show-all-keywords').addEventListener('click', () => {
        overlayDiv.classList.add('show');
      });
      document.getElementById('close').addEventListener('click', () => {
        overlayDiv.classList.remove('show');
      });


      function CreateKeywordsList(){
        const images = document.getElementById('gallery').querySelectorAll('img');
        const keywords = new Map(); // use Map instead of Set to store the frequency of each keyword
        for (const image of images) {
          const imageKeywords = image.dataset.keywords.toLowerCase().split(',');
          for (const imageKeyword of imageKeywords) {
            const trimmedKeyword = imageKeyword.trim();
            const count = keywords.get(trimmedKeyword) || 0; // get the current count of the keyword or 0 if not present
            keywords.set(trimmedKeyword, count + 1); // increment the count of the keyword
          }
        }
        const sortedKeywords = Array.from(keywords.entries()).sort((a, b) => b[1] - a[1]); // sort the keywords based on their frequency
        const keywordList = overlayDiv.querySelector('ul');
        keywordList.innerHTML = '';
        for (const [keyword, count] of sortedKeywords) {
          const listItem = document.createElement('li');
          listItem.textContent = `${keyword} (${count})`; // display the count of the keyword
          keywordList.appendChild(listItem);
        }
      }
  </script>
    
    <label>Filter by keywords: <input id="filterInput" type="text"></label>
    <div id="gallery"></div>
    <script>
      const galleryDiv = document.getElementById('gallery');

      function extractKeywords(text) {
        const firstLine = text.split('\n')[0];
        const regex = /(?<!\\)\((?:(?<!\\)\((?:\\[\s\S]|[^()]*)*\)|\\[\s\S]|[^()])*(?<!\\)\)/g;
        // Explanation of the regular expression:
        // (?<!\\) - Negative lookbehind to ensure that the opening parentheses is not escaped
        // \( - Matches an opening parenthesis
        // (?:(?<!\\)\((?:\\[\s\S]|[^()]*)*\)|\\[\s\S]|[^()])* - Matches any character inside the parentheses, taking into account escaped parentheses
        // (?<!\\)\) - Negative lookbehind to ensure that the closing parentheses is not escaped
        const keywords = firstLine.replace(regex, '').match(/[^,\n]+/g); // Remove the parentheses and then match anything that's not a comma or a newline
        return keywords;
      }
      // Filter images by keywords
      const filterInput = document.getElementById('filterInput');
      filterInput.addEventListener('input', () => {
        const filter = filterInput.value.toLowerCase();
        const images = galleryDiv.querySelectorAll('img');
        if (filter === '') {
          for (const image of images) {
            image.classList.remove('hidden');
          }
          return;
        }
        const keywords = filter.split(',');
        for (const image of images) {
          const imageKeywords = image.dataset.keywords.toLowerCase().split(',');
          const matches = keywords.every(keyword =>
            imageKeywords.some(imageKeyword => imageKeyword.trim() === keyword.trim())
          );
          if (matches) {
            image.classList.remove('hidden');
          } else {
            image.classList.add('hidden');
          }
        }
      });

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      // Add an image to the gallery
      async function addImage(src, keywords) {
          const image = document.createElement('img');
          image.src = src;
          image.classList.add('image');
          image.dataset.keywords = keywords.join(',');
          image.title = keywords.join(',');
          galleryDiv.prepend(image);
      }

      // Read and display all the images in the folder
      async function loadImages() {
        var startTime = performance.now()
        let imgcount = 0;
        let filecount = 0;
        let first = true;
        const folder = './images/txt2img-images'; // Replace with the path to your folder
        await fetch(folder)
          .then(response => response.text())
          .then(async html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = doc.querySelectorAll('a');
            
            for (const link of links) {
              const href = link.getAttribute('href');
              if (href.endsWith('.txt')) {
                const textFile = folder + '/' + href;
                const pngFile = folder + '/' + href.replace('.txt', '.png');
                await fetch(textFile)
                  .then(response => response.text())
                  .then(text => {
                    const keywords = extractKeywords(text);
                    imgcount++;
                    addImage(pngFile, keywords);
                  });
              }
              filecount++;
            }
          });
        await sleep(300);
        var endTime = performance.now()
        alert(`Done loading ${imgcount} images (${filecount} files) in ${endTime - startTime} ms`);
      }
      
      async function MAIN() {
        await loadImages();
        CreateKeywordsList();
      }
      MAIN();
    </script>
  </body>
</html>
